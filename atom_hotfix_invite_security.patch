--- a/src/lib/appUrl.ts
+++ b/src/lib/appUrl.ts
@@ -0,0 +1,18 @@
+// src/lib/appUrl.ts

+/**

+ * Returns the base URL of the app (no trailing slash).

+ * Priority:

+ *  1) NEXT_PUBLIC_APP_URL (recommended)

+ *  2) NEXT_PUBLIC_SITE_URL

+ *  3) VERCEL_URL (auto on Vercel, without protocol)

+ *  4) http://localhost:3000

+ */

+export function getAppUrl(): string {

+  const direct = process.env.NEXT_PUBLIC_APP_URL || process.env.NEXT_PUBLIC_SITE_URL

+  if (direct && direct.trim()) return direct.replace(/\/$/, '')

+

+  const vercel = process.env.VERCEL_URL

+  if (vercel && vercel.trim()) return `https://${vercel}`.replace(/\/$/, '')

+

+  return 'http://localhost:3000'

+}


--- a/src/lib/apiAuth.ts
+++ b/src/lib/apiAuth.ts
@@ -0,0 +1,43 @@
+// src/lib/apiAuth.ts

+import { NextResponse } from 'next/server'

+import { createSupabaseServerActionClient } from '@/lib/supabaseServer'

+import type { Role } from '@/lib/session'

+

+export const STAFF_ROLES: Role[] = ['reception', 'admin', 'super_admin']

+export const ADMIN_ROLES: Role[] = ['admin', 'super_admin']

+

+export type GuardOk = { ok: true; user_id: string; role: Role }

+export type GuardFail = { ok: false; res: NextResponse }

+

+export async function requireRole(roles: Role[]): Promise<GuardOk | GuardFail> {

+  const supa = createSupabaseServerActionClient()

+  const { data: auth } = await supa.auth.getUser()

+  if (!auth.user) {

+    return { ok: false, res: NextResponse.json({ ok: false, error: 'NOT_AUTHENTICATED' }, { status: 401 }) }

+  }

+

+  const { data: prof } = await supa

+    .from('profiles')

+    .select('role')

+    .eq('user_id', auth.user.id)

+    .maybeSingle<{ role: Role }>()

+

+  const role = (prof?.role ?? 'member') as Role

+

+  if (!roles.includes(role)) {

+    return {

+      ok: false,

+      res: NextResponse.json({ ok: false, error: 'FORBIDDEN', role }, { status: 403 }),

+    }

+  }

+

+  return { ok: true, user_id: auth.user.id, role }

+}

+

+export function requireStaff() {

+  return requireRole(STAFF_ROLES)

+}

+

+export function requireAdmin() {

+  return requireRole(ADMIN_ROLES)

+}


--- a/.env.example
+++ b/.env.example
@@ -2,4 +2,7 @@
 NEXT_PUBLIC_SUPABASE_URL=your_supabase_url

 NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key

 # Server-side only (never expose in client bundles)

-SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
+SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

+

+# App URL (used for invite redirects)

+NEXT_PUBLIC_APP_URL=http://localhost:3000


--- a/src/app/api/admin/stats/revenue/route.ts
+++ b/src/app/api/admin/stats/revenue/route.ts
@@ -5,6 +5,7 @@
 

 import { NextResponse } from 'next/server'

 import { createClient } from '@supabase/supabase-js'

+import { requireAdmin } from '@/lib/apiAuth'

 

 type Plan = '1m' | '3m' | '6m' | '12m' | 'sessions'

 

@@ -26,7 +27,10 @@
 }

 

 export async function GET(req: Request) {

-  try {

+    const gate = await requireAdmin();

+  if (!gate.ok) return gate.res;

+

+try {

     const url = process.env.NEXT_PUBLIC_SUPABASE_URL!

     const service = process.env.SUPABASE_SERVICE_ROLE_KEY!

     if (!url || !service) {

@@ -154,4 +158,4 @@
       { status: 500 },

     ))

   }

-}

+}

--- a/src/app/api/admin/audit/route.ts
+++ b/src/app/api/admin/audit/route.ts
@@ -3,6 +3,7 @@
 

 import { NextResponse } from 'next/server';

 import { createClient } from '@supabase/supabase-js';

+import { requireAdmin } from '@/lib/apiAuth'

 

 /**

  * GET /api/admin/audit

@@ -10,7 +11,10 @@
  * (Utilise la SERVICE_ROLE, donc accessible seulement côté serveur)

  */

 export async function GET() {

-  try {

+    const gate = await requireAdmin();

+  if (!gate.ok) return gate.res;

+

+try {

     const url = process.env.NEXT_PUBLIC_SUPABASE_URL!;

     const service = process.env.SUPABASE_SERVICE_ROLE_KEY!;

     if (!url || !service) {

@@ -33,4 +37,4 @@
   } catch (e: any) {

     return NextResponse.json({ ok: false, error: e.message ?? 'Server error' }, { status: 500 });

   }

-}

+}

--- a/src/app/api/admin/create-subscription/route.ts
+++ b/src/app/api/admin/create-subscription/route.ts
@@ -1,9 +1,13 @@
 export const runtime = 'nodejs';

 import { NextRequest, NextResponse } from 'next/server';

 import { createClient } from '@supabase/supabase-js';

+import { requireAdmin } from '@/lib/apiAuth'

 

 export async function POST(req: NextRequest) {

-  const { user_id, plan_type, remaining_classes, start_date, end_date } = await req.json();

+    const gate = await requireAdmin();

+  if (!gate.ok) return gate.res;

+

+const { user_id, plan_type, remaining_classes, start_date, end_date } = await req.json();

 

   if (!user_id || !plan_type) {

     return NextResponse.json({ ok:false, error:'Missing user_id or plan_type' }, { status:400 });

@@ -42,4 +46,4 @@
   if (error) return NextResponse.json({ ok:false, error:error.message }, { status:400 });

 

   return NextResponse.json({ ok:true });

-}

+}

--- a/src/app/api/admin/find-member/route.ts
+++ b/src/app/api/admin/find-member/route.ts
@@ -3,6 +3,7 @@
 

 import { NextRequest, NextResponse } from 'next/server';

 import { createClient } from '@supabase/supabase-js';

+import { requireAdmin } from '@/lib/apiAuth'

 

 /**

  * POST /api/admin/find-member

@@ -11,7 +12,10 @@
  * Utilise SERVICE_ROLE pour bypass RLS côté admin.

  */

 export async function POST(req: NextRequest) {

-  try {

+    const gate = await requireAdmin();

+  if (!gate.ok) return gate.res;

+

+try {

     const { email } = await req.json();

     if (!email || typeof email !== 'string') {

       return NextResponse.json({ ok: false, error: 'Missing email' }, { status: 400 });

@@ -59,4 +63,4 @@
  */

 export async function GET() {

   return NextResponse.json({ ok: true, hint: 'POST { email }' });

-}

+}

--- a/src/app/api/admin/members/route.ts
+++ b/src/app/api/admin/members/route.ts
@@ -1,9 +1,13 @@
 export const runtime = 'nodejs';

 import { NextRequest, NextResponse } from 'next/server';

 import { createClient } from '@supabase/supabase-js';

+import { requireAdmin } from '@/lib/apiAuth'

 

 export async function POST(req: NextRequest) {

-  const { q, role, limit = 50 } = await req.json().catch(() => ({}));

+    const gate = await requireAdmin();

+  if (!gate.ok) return gate.res;

+

+const { q, role, limit = 50 } = await req.json().catch(() => ({}));

   const admin = createClient(

     process.env.NEXT_PUBLIC_SUPABASE_URL!,

     process.env.SUPABASE_SERVICE_ROLE_KEY!

@@ -26,4 +30,4 @@
   if (error) return NextResponse.json({ ok:false, error:error.message }, { status:400 });

 

   return NextResponse.json({ ok:true, members:data });

-}

+}

--- a/src/app/api/admin/subscription-action/route.ts
+++ b/src/app/api/admin/subscription-action/route.ts
@@ -3,6 +3,7 @@
 

 import { NextRequest, NextResponse } from 'next/server';

 import { createClient, type SupabaseClient } from '@supabase/supabase-js';

+import { requireAdmin } from '@/lib/apiAuth'

 

 type Action = 'renew' | 'pause' | 'resume' | 'add_dropin';

 type Plan = 'monthly' | 'quarterly' | 'yearly';

@@ -57,7 +58,10 @@
 }

 

 export async function GET() {

-  return NextResponse.json({

+    const gate = await requireAdmin();

+  if (!gate.ok) return gate.res;

+

+return NextResponse.json({

     ok: true,

     hint:

       "POST { user_id, action: 'renew'|'pause'|'resume'|'add_dropin', start_date?: 'YYYY-MM-DD', plan?, amount?, actor_user_id?, payment?: { amount, method, paid_at?, currency?, note? } }",

@@ -292,4 +296,4 @@
   } catch (e: any) {

     return NextResponse.json({ ok: false, error: e.message ?? 'Server error' }, { status: 500 });

   }

-}

+}

--- a/src/app/api/debug/last-sub/route.ts
+++ b/src/app/api/debug/last-sub/route.ts
@@ -2,9 +2,13 @@
 

 import { NextRequest, NextResponse } from 'next/server';

 import { createClient } from '@supabase/supabase-js';

+import { requireAdmin } from '@/lib/apiAuth'

 

 export async function GET(req: NextRequest) {

-  try {

+    const gate = await requireAdmin();

+  if (!gate.ok) return gate.res;

+

+try {

     const url = process.env.NEXT_PUBLIC_SUPABASE_URL!;

     const service = process.env.SUPABASE_SERVICE_ROLE_KEY!;

     if (!url || !service) {

@@ -29,4 +33,4 @@
   } catch (e:any) {

     return NextResponse.json({ ok:false, error:e.message ?? 'Server error' }, { status:500 });

   }

-}

+}

--- a/src/app/api/members/create/route.ts
+++ b/src/app/api/members/create/route.ts
@@ -7,6 +7,7 @@
 import type { Role } from '@/lib/session'

 import { createSupabaseServerActionClient } from '@/lib/supabaseServer'

 import { createClient } from '@supabase/supabase-js'

+import { getAppUrl } from '@/lib/appUrl'

 

 type Body =

   | {

@@ -138,12 +139,7 @@
     }

 

     // 5) URL de redirection pour compléter l’invitation

-    const APP_URL =

-      process.env.NEXT_PUBLIC_APP_URL ||

-      process.env.NEXT_PUBLIC_SITE_URL ||

-      'http://localhost:3000'

-

-    const redirectTo = `${APP_URL.replace(/\/$/, '')}/auth/complete-invite`

+    const redirectTo = `${getAppUrl()}/auth/complete-invite`

 

     // 6) Tentative d’inviter l’utilisateur (email + lien)

     let userId: string | null = null

@@ -225,4 +221,4 @@
       ),

     )

   }

-}

+}

--- a/src/app/api/store/products/delete/route.ts
+++ b/src/app/api/store/products/delete/route.ts
@@ -1,6 +1,7 @@
 // src/app/api/store/products/delete/route.ts

 import { NextRequest, NextResponse } from 'next/server'

 import { createClient } from '@supabase/supabase-js'

+import { requireAdmin } from '@/lib/apiAuth'

 

 function createSupabaseForAPI() {

   const url = process.env.NEXT_PUBLIC_SUPABASE_URL

@@ -16,7 +17,10 @@
 export const revalidate = 0

 

 export async function DELETE(req: NextRequest) {

-  try {

+    const gate = await requireAdmin();

+  if (!gate.ok) return gate.res;

+

+try {

     const { searchParams } = new URL(req.url)

     const id = (searchParams.get('id') || '').trim()

     if (!id) {

@@ -35,4 +39,4 @@
   } catch (e: any) {

     return NextResponse.json({ ok: false, error: String(e?.message || e) }, { status: 500 })

   }

-}

+}

--- a/src/app/api/store/products/list/route.ts
+++ b/src/app/api/store/products/list/route.ts
@@ -1,6 +1,7 @@
 // src/app/api/store/products/list/route.ts

 import { NextRequest, NextResponse } from 'next/server'

 import { createClient } from '@supabase/supabase-js'

+import { requireStaff } from '@/lib/apiAuth'

 

 type Category = 'kimono' | 'rashguard' | 'short' | 'belt'

 

@@ -32,7 +33,10 @@
 export const revalidate = 0

 

 export async function GET(req: NextRequest) {

-  try {

+    const gate = await requireStaff();

+  if (!gate.ok) return gate.res;

+

+try {

     const supabase = createSupabaseForAPI()

 

     const { searchParams } = new URL(req.url)

@@ -97,4 +101,4 @@
       { status: 500 }

     )

   }

-}

+}

--- a/src/app/api/store/products/update/route.ts
+++ b/src/app/api/store/products/update/route.ts
@@ -1,6 +1,7 @@
 // src/app/api/store/products/update/route.ts

 import { NextRequest, NextResponse } from 'next/server'

 import { createClient } from '@supabase/supabase-js'

+import { requireAdmin } from '@/lib/apiAuth'

 

 type Category = 'kimono' | 'rashguard' | 'short' | 'belt'

 const CATEGORIES: readonly Category[] = ['kimono', 'rashguard', 'short', 'belt'] as const

@@ -99,4 +100,4 @@
   } catch (e: any) {

     return NextResponse.json({ ok: false, error: String(e?.message || e) }, { status: 500 })

   }

-}

+}

--- a/src/app/api/kiosk-register/route.ts
+++ b/src/app/api/kiosk-register/route.ts
@@ -1,5 +1,9 @@
-import { NextResponse } from 'next/server';

+export const runtime = 'nodejs';

+

+import { NextRequest, NextResponse } from 'next/server';

 import { createClient } from '@supabase/supabase-js';

+import { requireStaff } from '@/lib/apiAuth'

+import { getAppUrl } from '@/lib/appUrl'

 

 const admin = createClient(

   process.env.NEXT_PUBLIC_SUPABASE_URL!,

@@ -7,8 +11,11 @@
   { auth: { autoRefreshToken: false, persistSession: false } }

 );

 

-export async function POST(req: Request) {

+export async function POST(req: NextRequest) {

   try {

+    const gate = await requireStaff();

+    if (!gate.ok) return gate.res;

+

     const { first_name, last_name, email, phone } = await req.json();

 

     if (!email || !/^\S+@\S+\.\S+$/.test(email)) {

@@ -20,7 +27,7 @@
       email.toLowerCase(),

       {

         data: { first_name, last_name, phone, role: 'member' },

-        redirectTo: `${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'}/welcome`,

+        redirectTo: `${getAppUrl()}/auth/complete-invite`,

       }

     );

     if (inviteErr) {

@@ -55,4 +62,4 @@
   } catch (e: any) {

     return NextResponse.json({ ok: false, error: e?.message || 'Unexpected error' }, { status: 500 });

   }

-}

+}
